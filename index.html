<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mews Audit</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;margin:0;background:#0b1220;color:#e8eefc}
    .wrap{max-width:860px;margin:0 auto;padding:24px}
    .card{background:#111a2e;border:1px solid #1f2b4a;border-radius:14px;padding:18px;margin:14px 0}
    label{display:block;font-weight:600;margin:10px 0 6px}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid #2a3a63;background:#0c1426;color:#e8eefc}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    .btn{display:inline-block;padding:12px 14px;border-radius:12px;border:0;background:#3b82f6;color:#fff;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:#a9b7d6;font-size:13px;line-height:1.35}
    .msg{padding:10px 12px;border-radius:12px;margin:10px 0;display:none}
    .msg.ok{background:#13311d;border:1px solid #1e5a35}
    .msg.err{background:#3b1420;border:1px solid #7a2034}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Mews Audit</h1>
    <p class="muted">Enter your Mews Connector API Client token and Access token. The PDF will be generated by the backend and downloaded.</p>

    <div id="msgOk" class="msg ok"></div>
    <div id="msgErr" class="msg err"></div>

    <div class="card">
      <div class="row">
        <div>
          <label>Client token</label>
          <input id="clientToken" type="password" autocomplete="off" />
        </div>
        <div>
          <label>Access token</label>
          <input id="accessToken" type="password" autocomplete="off" />
        </div>
      </div>

      <p class="muted">Backend: <span id="backendUrl"></span></p>

      <button id="btn" class="btn" type="button">Generate PDF audit</button>
      <p class="muted" style="margin-top:10px">If the backend is on Render free tier it may take ~30–60 seconds to wake up.</p>
    </div>
  </div>

<script>
  const BACKEND = "https://mews-audit-backend.onrender.com";
  document.getElementById("backendUrl").textContent = BACKEND;

  const okBox = document.getElementById("msgOk");
  const errBox = document.getElementById("msgErr");
  const btn = document.getElementById("btn");

  function showOk(text){
    okBox.textContent = text;
    okBox.style.display = "block";
    errBox.style.display = "none";
  }
  function showErr(text){
    errBox.textContent = text;
    errBox.style.display = "block";
    okBox.style.display = "none";
  }

  btn.addEventListener("click", async () => {
    const clientToken = document.getElementById("clientToken").value.trim();
    const accessToken = document.getElementById("accessToken").value.trim();

    if(!clientToken || !accessToken){
      showErr("Please enter both tokens.");
      return;
    }

    btn.disabled = true;
    showOk("Generating audit…");

    try {
      // Send as form-data to match the Flask backend (/audit expects form fields).
      const form = new FormData();
      form.append("client_token", clientToken);
      form.append("access_token", accessToken);
      form.append("base_url", "https://app.mews-demo.com/api/connector/v1");
form.append("client", "mews-audit");


      const res = await fetch(`${BACKEND}/audit`, {
        method: "POST",
        body: form,
        // IMPORTANT: do not set credentials/cookies; we’re not using sessions.
      });

      if(!res.ok){
        const text = await res.text().catch(()=> "");
        showErr(`Audit failed (HTTP ${res.status}). ${text ? "Try again or check backend logs." : ""}`);
        btn.disabled = false;
        return;
      }

      const blob = await res.blob();
      const cd = res.headers.get("content-disposition") || "";
      const match = cd.match(/filename="?([^"]+)"?/i);
      const filename = match ? match[1] : "mews-audit.pdf";

      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      window.URL.revokeObjectURL(url);

      showOk("Done. Your PDF download should have started.");
    } catch (e) {
      showErr("Could not reach the backend. Check the backend URL and CORS settings.");
    } finally {
      btn.disabled = false;
      // Clear tokens from the page (best effort)
      document.getElementById("clientToken").value = "";
      document.getElementById("accessToken").value = "";
    }
  });
</script>
</body>
</html>
